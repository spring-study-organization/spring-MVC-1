# Hello 서블릿

스프링 부트 환경에서 서블릿 등록하고 사용해보자.

> 참고
> 서블릿은 톰캣 같은 웹 애플리케이션 서버를 직접 설치하고,그 위에 서블릿 코드를 클래스 파일로 빌드해서
올린 다음, 톰캣 서버를 실행하면 된다. 하지만 이 과정은 매우 번거롭다.
> 스프링 부트는 톰캣 서버를 내장하고 있으므로, 톰캣 서버 설치 없이 편리하게 서블릿 코드를 실행할 수
있다.

# 스프링 부트 서블릿 환경 구성

## @ServletComponentScan
스프링 부트는 서블릿을 직접 등록해서 사용할 수 있도록 `@ServletComponentScan` 을 지원한다. 다음과
같이 추가하자.

## hello.servlet.ServletApplication
```java
package hello.servlet;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.web.servlet.ServletComponentScan;

@ServletComponentScan //서블릿 자동 등록 @SpringBootApplication
public class ServletApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServletApplication.class, args);
    }
}   
```

## 서블릿 등록하기

처음으로 실제 동작하는 서블릿 코드를 등록해보자.

```java
@WebServlet(name = "helloServlet", urlPatterns = "/hello")
  public class HelloServlet extends HttpServlet {
    
    @Override
    protected void service(HttpServletRequest request, HttpServletResponse
            response) throws ServletException, IOException {
        
        System.out.println("HelloServlet.service");
        System.out.println("request = " + request);
        System.out.println("response = " + response);
        
        String username = request.getParameter("username");
        System.out.println("username = " + username);
        
        response.setContentType("text/plain");
        response.setCharacterEncoding("utf-8");
        response.getWriter().write("hello " + username);
    }
}
```

* @WebServlet 서블릿 애노테이션
  * name: 서블릿 이름 
  * urlPatterns: URL 매핑
  
HTTP 요청을 통해 매핑된 URL이 호출되면 서블릿 컨테이너는 다음 메서드를 실행한다.
```java
protected void service(HttpServletRequest request, HttpServletResponse response)
```
  
* 웹 브라우저 실행
  * http://localhost:8080/hello?username=world
  * 결과: hello world 
  
* 콘솔 실행결과
```
HelloServlet.service
request = org.apache.catalina.connector.RequestFacade@5e4e72
response = org.apache.catalina.connector.ResponseFacade@37d112b6
username = world
```

# 서블릿 컨테이너 동작 방식 설명

## 내장 톰캣 서버 생성

<img src="img/서블릿-컨테이너-동작-방식-1.png">

1. 스프링 부트를 실행하면 스프링 부트가 내장 톰캣 서버를 실행해줌
2. 톰캣 서버 내부의 서블릿 컨테이너에 서블릿들을 생성

<img src="img/서블릿-컨테이너-동작-방식-2.png">

3. 브라우저가 요청을 보내면 위의 그림처럼 HTTP 메시지를 만들고 서버로 요청을 보냄

<img src="img/서블릿-컨테이너-동작-방식-3.png">

4. 요청이 오면 request, response 객체를 만들고 기존에 만들었던 싱글톤의 서블릿을 호출하고 만든 객체를 넘겨줌.
5. 서블릿에서 개발자가 만든 로직을 수행하고 다 완료되면 response 객체를 위 그림의 HTTP 응답 메시지로 바꿔서 브라우저로 응답을 보냄.

> 참고
> HTTP 응답에서 Content-Length는 웹 애플리케이션 서버가 자동으로 생성해준다.


